<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Sonos-Controller</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="author" content="https://github.com/doncato" />
        <meta name="description" content="Control Sonos Speaker in your network" />
        <meta name="keywords" content="App,Sonos,Sound,Speaker,Network" />

        <link rel="preload" href="/rsc/style.css" as="style" />

        <meta content="Sonos-Controller" property="og:title" />
        <meta content="Control Sonos Speaker in your network" property="og:description" />
        <meta content="Sonos-Controller" property="og:site_name" />
        <meta content="website" property="og:type" />
        <meta content="#f3f3f3" data-react-helmet="true" name="theme-color" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link media="screen" />
        <link rel="shortcut icon" type="image/png" href="/rsc/logo.png" />
        <link rel="icon" type="image/png" href="/img/logo.png" />
        <link rel="stylesheet" href="/rsc/style.css" />

    </head>
    <body>
        <div id="marker-list">○</div>
        <div class="content">
            <h2 id="○">Sonos Controller</h2>
            <h4>Control Sonos Speaker in your network</h4>
            <noscript>
                This site relies on JavaScript.
            </noscript>
            <hr>
            <b id="description">Available music files</b>
            <div class='header'>
                <div class='back-btn'>
                    <button id='btn-back' onclick='fileButtonBack("info-bar")'>
                        ← back
                    </button>
                </div>
                <div id='info-bar'>
                    /
                </div>
            </div>
            <div id="datalist">
                Not Found
            </div>
        </div>
        <script>
            function fileButtonHandler(obj) {
                var loc = document.getElementById('info-bar').innerHTML + obj.slice(5,);
                if (loc.endsWith('/')) {
                    getFiles(loc)
                } else {
                    getSpeaker("", loc)
                }
            }
            function fileButtonBack() {
                var pathnow = document.getElementById('info-bar').innerHTML;
                if (pathnow.endsWith('/')) {
                    var overhead = -2;
                } else {
                    var overhead = -1;
                }
                var path = pathnow.split('/').slice(0,overhead).join('/') + '/';
                getFiles(path)
            }
            function speakerButtonHandler(obj, path) {
                var spk = obj.slice(8,);
                const xhr = new XMLHttpRequest();
                if (path.startsWith('/')) {
                    path = path.slice(1,);
                }
                xhr.open("GET", `http://${location.host}/api/control/play/${spk}/${path}`)
                xhr.send()
                // When the Request is completed
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        getFiles("")
                    } else {
                        console.log("Failed to Play")
                    }
                }
                // When a network error is encountered
                xhr.onerror = function() {
                    console.log("Failed to get response")
                }
                // Log progress
                xhr.onprogress = function(e) {
                    if (e.lengthComputable) {
                        console.log(`${e.loaded} B of ${e.total} B loaded...`)
                    } else {
                        console.log(`${e.loaded} B loaded...`)
                    }
                }
            }

            function writeFiles(data, loc) {
                document.getElementById("description").innerHTML = "Available music files";
                document.getElementById("info-bar").innerHTML = loc;
                var str = "<ul>";
                var last_char = "";
                data.sort();
                for (var i = 0; i < data.length; i++) {
                    var jumper = "";
                    var e = data[i]
                    var first_char = e.toLowerCase()[0]
                    if (last_char !== first_char) {
                        last_char = first_char
                        jumper = `<span class='marker' id='${first_char}'></span>`
                    }
                    str += "<li><button onclick='fileButtonHandler(this.id)' " + `id='file-${e}'>` + e + "</button>" + jumper + "</li>"
                }
                str += "</ul>"
                document.getElementById("datalist").innerHTML = str;

                let markers = ["<a href='#○'>○</a>"];
                let ms = document.getElementsByClassName("marker");
                for (var i = 0; i < ms.length; i++) {
                    markers.push(`<a href='#${ms[i].id}'>${ms[i].id.toUpperCase()}</a>`);
                }
                document.getElementById("marker-list").innerHTML = markers.join("<br>");
            }

            function getFiles(loc) {
                const xhr = new XMLHttpRequest()
                if (!loc.startsWith("/")) {
                    var path = "/" + loc;
                } else {
                    var path = loc;
                }
                xhr.open("GET", `http://${location.host}/api/filelist${path}`)
                xhr.send()
                // When the Request is completed
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        data = JSON.parse(xhr.responseText)
                        console.log(data.count)
                        writeFiles(data, path)
                    } else {
                        console.log("No filelist available")
                    }
                }
                // When a network error is encountered
                xhr.onerror = function() {
                    console.log("Failed to get filelist")
                }
                // Log progress
                xhr.onprogress = function(e) {
                    if (e.lengthComputable) {
                        console.log(`${e.loaded} B of ${e.total} B loaded...`)
                    } else {
                        console.log(`${e.loaded} B loaded...`)
                    }
                }
            }

            function writeSpeaker(data, path) {
                document.getElementById("description").innerHTML = "Available speakers";
                document.getElementById("info-bar").innerHTML = path;
                var str = "<ul>";
                for (var i = 0; i < data.length; i++) {
                    var e = data[i];
                    str += `<li><button onclick='speakerButtonHandler(this.id, "${path}")'`  + `id='speaker-${e.ip}'>` + e.ip + ` (${e.trackname} [${e.trackelapsed} / ${e.trackduration})s]` + "</button></li>";
                }
                str += "</ul>"
                document.getElementById("datalist").innerHTML = str;
                document.getElementById("marker-list").innerHTML = "<a href='#○'>○</a>";
            }

            function getSpeaker(spk, path) {
                const xhr = new XMLHttpRequest();
                xhr.open("GET", `http://${location.host}/api/speakers/${spk}`)
                xhr.send()
                // When the Request is completed
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        data = JSON.parse(xhr.responseText)
                        console.log(data.count)
                        writeSpeaker(data, path)
                    } else {
                        console.log("No speakerlist available")
                    }
                }
                // When a network error is encountered
                xhr.onerror = function() {
                    console.log("Failed to get filelist")
                }
                // Log progress
                xhr.onprogress = function(e) {
                    if (e.lengthComputable) {
                        console.log(`${e.loaded} B of ${e.total} B loaded...`)
                    } else {
                        console.log(`${e.loaded} B loaded...`)
                    }
                }
            }

            // Make a request to the Backend and ask for a filelist
            getFiles("")




        </script>
    </body>
</html>
